<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CENTER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, Helvetica, sans-serif;
        }

        .btn {
            all: unset;
            cursor: pointer;
        }

        .icon {
            height: 1.5em;
            width: auto;
            vertical-align: middle;
        }

        #controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.2rem;
        }

        #play-pause-btn {
            border: 1px solid #000;
            /* border: 2px solid #cecece; */
            height: 40px;
            width: 40px;
            border-radius: 50%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flex {
            display: flex;
            align-items: center;
        }

        .center {
            justify-content: center;
        }

        .space-between {
            justify-content: space-between;
        }

        .center-c {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .container-grid {
            display: grid;
            /* Centrado eficiente y limpio */
            place-items: center;
            /* Asegura que el contenedor ocupe la pantalla completa */
            height: 100vh;
        }

        .container-flex {
            display: flex;
            /* Centrado horizontal */
            justify-content: center;
            /* Centrado vertical */
            align-items: center;
            height: 100vh;
        }

        .mobile {
            /* Tamaño del contenido */
            width: 276px;
            height: 555px;
            background-color: #fff;
            border-radius: 30px;
            border: 2px solid rgba(0, 0, 0, 0.3);
            box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3);
            /* box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); */
        }

        .screen {
            position: relative;
            /* background: #262626; */
            border: 2px solid rgba(0, 0, 0, 0.3);
            /* box-shadow: inset 0 0 8px rgba(0, 0, 0, 0.3); */
            width: 256px;
            height: 430px;
            margin: 58px auto;
            overflow: hidden;
            padding: .25rem;
            font-size: 13.333px;
        }

        .overlay {
            /* position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 1);
            z-index: 9999; */
        }

        .screen::before {
            /* content: "";
            position: absolute;
            top: 0;
            left: 0;
            background: rgba(255, 255, 255, 0.1);
            width: 100%;
            height: 100%;
            transform: skewX(-5deg) translateX(-50%); */
        }

        .home {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #fff;
            border: 2px solid #cecece;
            cursor: pointer;
            box-shadow: inset 0 0 7px rgba(0, 0, 0, 0.1);
        }

        .inner {
            position: absolute;
            top: 32px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 4px;
            border-radius: 2px;
            background: #262626;
        }

        .inner::before {
            content: "";
            position: absolute;
            top: -2px;
            left: -22px;
            background: #262626;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .inner::after {
            content: "";
            position: absolute;
            top: -16px;
            left: 50%;
            transform: translateX(-50%);
            background: #262626;
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .mb-1 {
            margin-bottom: 1rem;
        }

        .mb-2 {
            margin-bottom: 2rem;
        }

        .mb-3 {
            margin-bottom: 3rem;
        }

        .mt-1 {
            margin-top: 1rem;
        }

        .mt-2 {
            margin-top: 2rem;
        }

        .mt-3 {
            margin-top: 3rem;
        }

        .playing {
            /* background-color: #283041 !important; */
            background-color: #e5e5e5 !important;
            /* color: #fff; */
        }

        .hidden {
            display: none;
        }

        .visible {
            display: block;
        }

        .text-center {
            text-align: center;
        }

        .text-right {
            text-align: right;
        }

        .fw-400 {
            font-weight: 400;
        }

        .fw-500 {
            font-weight: 500;
        }

        .fw-600 {
            font-weight: 600;
        }

        /* Input range styling */
        .slider {
            -webkit-appearance: none;
            width: 100%;
            margin: 0;
            background: transparent;
            /* height: 4px; */
        }

        .slider:focus {
            outline: none;
        }

        /* Google Chrome */
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            margin-top: -5px;
            height: 13px;
            width: 13px;
            border-radius: 50%;
            background-color: #676774;
            cursor: pointer;
        }

        .slider::-webkit-slider-runnable-track {
            height: 4px;
            cursor: pointer;
            background-color: #283041;
            border-radius: 2px;
        }

        .slider:focus::-webkit-slider-runnable-track {
            background-color: #e9e9ed;
        }

        /* Mozilla Firefox */
        .slider::-moz-range-thumb {
            height: 13px;
            width: 13px;
            border: none;
            border-radius: 50%;
            background-color: #676774;
            cursor: pointer;
        }

        .slider::-moz-range-progress {
            background-color: #000;
            height: 4px;
            border-radius: 2px;
        }

        .slider::-moz-range-track {
            height: 4px;
            cursor: pointer;
            /* background-color: rgba(65, 0, 0, 255); */
            background-color: #e9e9ed;
            border-radius: 2px;
        }

        /* End input range styling */

        .fs-12 {
            font-size: .75rem;
        }

        .fs-14 {
            font-size: .875rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            user-select: none;
            table-layout: fixed;
        }

        .table tr td:nth-child(1) {
            width: 12.5%;
        }

        .table tr td:nth-child(2) {
            width: 70%;
        }

        .table tr td:nth-child(3) {
            width: 17.5%;
            text-align: right;
        }

        .table td {
            padding: .5rem;
        }

        .table tr:hover {
            background-color: #f2f2f2;
            cursor: pointer;
        }

        .table h3,
        h4 {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .table h3 {
            font-size: 14px;
            font-weight: 500;
        }

        .table h4 {
            font-size: 12px;
            opacity: .8;
            font-weight: 500;
        }

        #song-info-container {
            overflow: hidden;
            position: relative;
            margin: 1rem;
        }

        #song-info {
            text-align: center;
            white-space: nowrap;
            animation: none;
            font-size: 16px;
        }

        /* Definición de la animación para el desplazamiento */
        @keyframes slideIn {
            0% {
                transform: translateX(100%);
                /* Comienza fuera de la pantalla por la derecha */
            }

            100% {
                transform: translateX(-100%);
                /* Se mueve hacia fuera de la pantalla por la izquierda */
            }
        }
    </style>
</head>

<body>

    <div class="center-c">

        <div class="mobile">

            <div class="screen">

                <!-- Eject and Playlists btn -->
                <div class="flex space-between" style="margin: 0 .5rem 1rem .5rem;">

                    <!-- Eject btn -->
                    <button id="fileSelect" class="btn" title="Seleccionar archivo(s)">
                        <!-- Eject icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M96 384L96 320L320 80L544 320L544 384L96 384zM544 544L96 544L96 448L544 448L544 544z" />
                        </svg>
                        <!-- Input file -->
                        <input type="file" id="input-file" multiple accept="audio/*" class="hidden">
                    </button>

                    <!-- Bars btn -->
                    <button class="btn">
                        <!-- Bars icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M96 128L544 128L544 192L96 192L96 128zM96 288L544 288L544 352L96 352L96 288zM544 448L544 512L96 512L96 448L544 448z" />
                        </svg>
                    </button>

                </div>

                <!-- Song information -->
                <div id="song-info-container" style="margin-bottom: 1.5rem;">
                    <h3 id="song-info" class="text-center fw-400">Grupo Río - Todo estaba bien</h3>
                </div>

                <!-- Audio controls -->
                <div id="controls" class="mb-1">

                    <!-- Shuffle btn -->
                    <button id="shuffle-btn" class="btn" title="Activar orden aleatorio">
                        <!-- Shuffle icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M576 192L448 296L448 224L400 224L358 280L318 226.7C350.1 183.9 366.7 161.7 368 160L448 160L448 88L576 192zM384 480L368 480L358.4 467.2L176 224L64 224L64 160L208 160L217.6 172.8L400 416L448 416L448 344L576 448L448 552L448 480L384 480zM258 413.3C225.9 456 209.3 478.3 208 480L64 480L64 416L176 416L218 360L258 413.3z" />
                            <rect width="80" height="80" x="64" y="280" fill="currentColor" class="hidden"></rect>
                        </svg>
                    </button>

                    <!-- Backward btn -->
                    <button id="backward-btn" class="btn" title="Anterior">
                        <!-- Backward-step icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M192 360L192 544L128 544L128 96L192 96L192 280L512 80L512 560L192 360z" />
                        </svg>
                    </button>

                    <!-- Play pause btn -->
                    <button id="play-pause-btn" class="btn" title="Reproducir">
                        <!-- Play icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon" style="height: 2em;">
                            <path fill="currentColor" d="M128 80L128 560L560 320L128 80z" />
                        </svg>
                        <!-- Pause icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon hidden"
                            style="height: 2em;">
                            <path fill="currentColor"
                                d="M288 96L128 96L128 544L288 544L288 96zM512 96L352 96L352 544L512 544L512 96z" />
                        </svg>
                    </button>

                    <!-- Forward-step btn -->
                    <button id="forward-btn" class="btn" title="Siguiente">
                        <!-- Forward-step icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M448 360L448 544L512 544L512 96L448 96L448 280L128 80L128 560L448 360z" />
                        </svg>
                    </button>

                    <!-- Repeat btn -->
                    <button id="repeat-btn" class="btn" title="Repetir playlist">
                        <!-- Repeat icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M416 272L416 192L128 192L128 352L64 352L64 128L416 128L416 48L440 48L552 160L440 272L416 272zM224 512L224 592L200 592L88 480L200 368L224 368L224 448L512 448L512 288L576 288L576 512L224 512z" />
                            <rect width="80" height="80" x="280" y="280" fill="currentColor" class="hidden"></rect>
                        </svg>
                        <!-- Repeat-1 icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon hidden">
                            <path fill="currentColor"
                                d="M416 192L416 272L440 272L552 160L440 48L416 48L416 128L64 128L64 352L128 352L128 192L416 192zM224 592L224 512L576 512L576 288L512 288L512 448L224 448L224 368L200 368L88 480L200 592L224 592zM288 304L304 304L304 384L352 384L352 256L280 256L280 304L288 304z" />
                        </svg>
                    </button>

                </div>

                <!-- Current time slider -->
                <div class="fs-12" style="padding: .5rem;margin-bottom: .5rem;">
                    <input type="range" id="audio-current-time-slider" class="slider" min="0" max="210.581768" value="0"
                        step=".01" style="height: 4px;">
                    <div class="flex space-between">
                        <span id="current-time">0:00</span><span id="duration">3:31</span>
                    </div>
                </div>

                <!-- Volume controls-->
                <div class="fs-12 flex center" style="gap: 1rem;width: 80%;margin: 0 auto;">
                    <!-- Volumen-xmark btn -->
                    <button id="volume-xmark-btn" class="btn" title="Silenciar">
                        <!-- Volume-xmark icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon">
                            <path fill="currentColor"
                                d="M32 416L128 416L320 568L320 72L128 224L32 224L32 416zM577.9 256L544 222.1C537.7 228.4 516.4 249.7 480 286.1C443.6 249.7 422.3 228.4 416 222.1L382.1 256C388.4 262.3 409.7 283.6 446.1 320C409.7 356.4 388.4 377.7 382.1 384L416 417.9C422.3 411.6 443.6 390.3 480 353.9C516.4 390.3 537.7 411.6 544 417.9L577.9 384C571.6 377.7 550.3 356.4 513.9 320C550.3 283.6 571.6 262.3 577.9 256z" />
                        </svg>
                    </button>
                    <!-- Volume slider -->
                    <input type="range" id="volume-slider" class="slider" min="0" max="100" value="100" step="1">
                    <!-- Volume-high btn -->
                    <button id="volume-high-btn" class="btn" title="Activar sonido">
                        <!-- Volume-high icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640" class="icon text-right">
                            <path fill="currentColor"
                                d="M32 416L128 416L320 568L320 72L128 224L32 224L32 416zM382.3 282.7C393.1 291.6 400 305 400 320C400 335 393.1 348.4 382.3 357.3L370.9 366.6L399.7 405L412.5 394.6C434.1 376.9 448 350.1 448 320C448 289.9 434.1 263.1 412.5 245.5L399.7 235.1L370.9 273.5L382.3 282.8zM442.8 208.2C475.3 234.7 496 274.9 496 320C496 365.1 475.3 405.3 442.8 431.8L428.5 443.4L457.3 481.8L473 469C516.2 433.8 543.9 380.1 543.9 320C543.9 259.9 516.2 206.2 473 171L457.3 158.2L428.5 196.6L442.8 208.2zM503.3 133.7C557.5 177.8 592 244.8 592 320C592 395.2 557.5 462.2 503.3 506.3L486.1 520.3L514.8 558.5L515 558.7L533.6 543.6C598.5 490.8 640 410.2 640 320C640 229.8 598.5 149.3 533.6 96.5L515 81.4L514.8 81.6L486.2 119.8L503.4 133.8z" />
                        </svg>
                    </button>

                </div>

                <!-- Table  -->
                <div style="height: 176px;overflow-y: auto;overflow-x: hidden;margin-top: 1.5rem;" class="">
                    <!-- https://alistapart.com/article/web-typography-tables/ -->

                    <!-- Song table -->
                    <table class="table">
                        <tbody id="tbody">
                            <tr data-id="1">
                                <td><span>1</span></td>
                                <td>
                                    <h3>Cartas sin marcar</h3>
                                    <h4>Andrés Calamaro</h4>
                                </td>
                                <td><span>4:25</span></td>
                            </tr>
                            <tr data-id="2">
                                <td><span>2</span></td>
                                <td>
                                    <h3>Todo estaba bien</h3>
                                    <h4>Grupo Río</h4>
                                </td>
                                <td><span>4:50</span></td>
                            </tr>
                            <tr data-id="3">
                                <td><span>3</span></td>
                                <td>
                                    <h3>Lunes por la madrugada</h3>
                                    <h4>Los Abuelos de la Nada</h4>
                                </td>
                                <td><span>3:14</span></td>
                            </tr>
                            <tr data-id="4">
                                <td><span>4</span></td>
                                <td>
                                    <h3>Suna</h3>
                                    <h4>Mar de Copas</h4>
                                </td>
                                <td><span>4:21</span></td>
                            </tr>
                            <tr data-id="5">
                                <td><span>5</span></td>
                                <td>
                                    <h3>Te siento de sólo pensar</h3>
                                    <h4>Pedro Suárez Vértiz</h4>
                                </td>
                                <td><span>3:22</span></td>
                            </tr>
                            <tr data-id="6">
                                <td><span>6</span></td>
                                <td>
                                    <h3>Trátame Suavemente</h3>
                                    <h4>Soda Stereo</h4>
                                </td>
                                <td><span>3:22</span></td>
                            </tr>
                            <tr data-id="7">
                                <td><span>7</span></td>
                                <td>
                                    <h3>Sin disfraz</h3>
                                    <h4>Virus</h4>
                                </td>
                                <td><span>5:30</span></td>
                            </tr>
                        </tbody>
                    </table>

                </div>

            </div>
            <div class="home"></div>
            <div class="inner"></div>

        </div>

    </div>

    <!-- <script src="js/script.js"></script> -->
    <script>

        "use strict";

        const d = document;

        const PATH = `https://neobte.github.io/music-player/audio/rock/`;

        let previousRowActive = null;

        let timeoutID,
            isFirstClick = true;
        let repeatState = 0,
            isRepeatAll = false;

        let songList, songListCopy, songMap, numFiles, songIndex;
        let isShuffle = false;
        let isLocalFiles = false;

        const audioPlayer = new Audio();

        const inputFile = d.getElementById("input-file");
        const tbody = d.getElementById("tbody");

        const songInfo = d.getElementById("song-info");
        const parentElementOffsetWidth = songInfo.parentElement.offsetWidth;

        const shuffleBtn = d.getElementById("shuffle-btn");
        const repeatBtn = d.getElementById("repeat-btn");
        const backwardBtn = d.getElementById("backward-btn");
        const forwardBtn = d.getElementById("forward-btn");
        const playPauseBtn = d.getElementById("play-pause-btn");
        const [playIcon, pauseIcon] = playPauseBtn.children;

        const audioCurrentTimeSlider = d.getElementById("audio-current-time-slider");
        const currentTime = d.getElementById("current-time");
        const duration = d.getElementById("duration");

        const volumeSlider = d.getElementById("volume-slider");
        const volumeXmarkBtn = d.getElementById("volume-xmark-btn");
        const volumeHighBtn = d.getElementById("volume-high-btn");
        let currentVolume = 1; // 1 = 100 %

        // Iniciamos la solicitud al servidor
        d.addEventListener("DOMContentLoaded", () => {
            init();
        });

        const init = () => {
            sendHttpRequest("GET", PATH + "playlist.json", null, handleResponse);
            audioCurrentTimeSlider.value = 0;
            volumeSlider.value = 100;
        };

        const handleResponse = (response) => {
            // songList = JSON.parse(response).slice(0, 10);
            songList = JSON.parse(response);
            songListCopy = [...songList];
            songMap = new Map(songListCopy.map((song) => [song.id, song]));
            // console.log(songMap);

            numFiles = songList.length;

            songIndex = 0;

            // ¿Podemos eliminar esta condición? No
            if (songIndex < numFiles) {
                // 1. Mostramos la lista de canciones
                displaySongs(songListCopy);
                // 2. Cargamos el índice cero por defecto
                loadSong(songIndex);
                // Siendo el índice cero, no hace falta desplazar el scroll
            }
        };

        d.getElementById("fileSelect").addEventListener("click", (e) => {
            if (inputFile) {
                inputFile.click();
            }
        });

        inputFile.addEventListener("change", (e) => {
            if (e.target.files.length === 0) return;
            isLocalFiles = true;
            const fileList = e.target.files;
            numFiles = fileList.length;
            const promises = new Array(numFiles);

            // Lógica para mostrar la duración de las canciones
            for (let i = 0; i < numFiles; i++) {
                const objectURL = URL.createObjectURL(fileList[i]);
                promises[i] = new Promise((resolve) => {
                    const audio = new Audio(objectURL);
                    audio.addEventListener("loadedmetadata", (e) => {
                        resolve({
                            id: i + 1,
                            name: fileList[i].name,
                            duration: audio.duration,
                            url: objectURL,
                            type: fileList[i].type,
                            size: fileList[i].size,
                        });
                        // URL.revokeObjectURL(objectURL);
                    });
                    audio.load();
                });
            }

            songIndex = 0;

            Promise.all(promises).then((value) => {
                songList = value;
                songListCopy = [...songList];

                songMap = new Map(songListCopy.map((song) => [song.id, song]));

                // 1. Mostramos la lista de canciones
                displaySongs(songListCopy);

                // 2. Reproducimos el indice cero
                loadSong(songIndex);
                playAudio();

                // Si shuffle is true, barajamos el array
                if (isShuffle) {
                    shufflePlayback(songListCopy);
                }
            });
            // Hot summer night
            // https://www1.maxcine.net/noches-de-verano-pelicula-gratis/
            // https://cuevana-4.com/peliculas/noches-de-verano
        });

        // Volume slider
        volumeSlider.addEventListener("input", () => {
            // volumeDisplay.textContent = volumeSlider.value;
            audioPlayer.volume = volumeSlider.value / 100;
            if (volumeSlider.value === "0") {
                // volumeBtn.children[0].style.display = "none";
                // volumeBtn.children[1].style.display = "block";
                audioPlayer.muted = true;
                currentVolume = 0.5; // 50 %
                // volumeHighBtn.title = "Activar sonido";
            } else {
                // volumeBtn.children[1].style.display = "none";
                // volumeBtn.children[0].style.display = "block";
                audioPlayer.muted = false;
                currentVolume = volumeSlider.value / 100; //  Values are between 0 y 100
                // volumeXmarkBtn.title = "Silenciar";
            }
        });

        volumeXmarkBtn.addEventListener("click", () => {
            audioPlayer.volume = 0;
            volumeSlider.value = 0;

            // audioPlayer.muted = !audioPlayer.muted;
            // if (audioPlayer.muted) {
            //     audioPlayer.volume = 0;
            //     volumeSlider.value = 0;
            //     // volumeBtn.children[0].style.display = "none";
            //     // volumeBtn.children[1].style.display = "block";
            //     // volumeBtn.title = "Activar sonido";
            // } else {
            //     audioPlayer.volume = currentVolume; // Values are  between 0.1 and 1, where 1 = 100 %
            //     volumeSlider.value = currentVolume * 100; // Values are between 0 and 100
            //     // volumeBtn.children[1].style.display = "none";
            //     // volumeBtn.children[0].style.display = "block";
            //     // volumeBtn.title = "Silenciar";
            // }
            // volumeDisplay.textContent = volumeSlider.value;
        });

        volumeHighBtn.addEventListener("click", () => {
            audioPlayer.volume = 1;
            volumeSlider.value = 100;
        });

        // Current time slider
        audioPlayer.addEventListener("loadedmetadata", () => {
            currentTime.textContent = formatTime(audioPlayer.currentTime);
            duration.textContent = formatTime(audioPlayer.duration);
            audioCurrentTimeSlider.value = audioPlayer.currentTime;
            audioCurrentTimeSlider.max = audioPlayer.duration;
        });

        audioPlayer.addEventListener("timeupdate", () => {
            currentTime.textContent = formatTime(audioPlayer.currentTime);
            audioCurrentTimeSlider.value = audioPlayer.currentTime;
        });

        audioCurrentTimeSlider.addEventListener("input", () => {
            audioPlayer.currentTime = audioCurrentTimeSlider.value;
        });

        // Audio ended event
        audioPlayer.addEventListener("ended", (e) => {
            if (songIndex >= numFiles - 1 && !isRepeatAll) {
                playIcon.style.display = "block";
                pauseIcon.style.display = "none";
                playPauseBtn.title = "Reproducir";
                return;
            }
            forwardBtn.click();
            playAudio();
        });

        // Shuffle event
        shuffleBtn.addEventListener("click", (e) => {
            if (audioPlayer.src === "") return;
            isShuffle = !isShuffle;
            if (isShuffle) {
                shufflePlayback(songListCopy);
                // Seteamos el indice a cero
                songIndex = 0;
                shuffleBtn.children[0].querySelector("rect").style.display = "block";
                shuffleBtn.title = "Desactivar orden aleatorio";
            } else {
                sequentialPlayback(songList);
                shuffleBtn.children[0].querySelector("rect").style.display = "none";
                shuffleBtn.title = "Activar orden aleatorio";
            }
        });

        // Play/pause event
        playPauseBtn.addEventListener("click", (e) => {
            if (audioPlayer.src === "") return;
            audioPlayer.paused ? playAudio() : pauseAudio();
        });

        // Backward event
        backwardBtn.addEventListener("click", (e) => {
            if (audioPlayer.src === "") return;
            clearTimeout(timeoutID);
            if (audioPlayer.currentTime > 0 && isFirstClick) {
                audioPlayer.currentTime = 0;
                isFirstClick = false;
                setTimeout(() => {
                    isFirstClick = true;
                }, 3000);
            } else if (!isFirstClick || audioPlayer.currentTime === 0) {
                songIndex = (songIndex - 1 + numFiles) % numFiles;
                if (!audioPlayer.paused) {
                    loadSong(songIndex);
                    audioPlayer.play();
                } else {
                    loadSong(songIndex);
                }
                isFirstClick = true;
            }
            scrollToRow();
        });

        // Forward event
        forwardBtn.addEventListener("click", (e) => {
            if (audioPlayer.src === "") return;
            songIndex = (songIndex + 1) % numFiles;
            if (!audioPlayer.paused) {
                loadSong(songIndex);
                playAudio();
            } else {
                loadSong(songIndex);
            }
            scrollToRow();
        });


        // Repeat event
        repeatBtn.addEventListener("click", (e) => {
            if (audioPlayer.src === "") return;
            repeatState = (repeatState + 1) % 3;

            if (repeatState === 0) {
                audioPlayer.loop = false;
                repeatBtn.title = "Repetir playlist";
                repeatBtn.children[1].style.display = "none";
                repeatBtn.children[0].style.display = "block";
                return;
            }

            if (repeatState === 1) {
                isRepeatAll = true;
                repeatBtn.title = "Repetir canción indefinidamente";
                repeatBtn.children[0].querySelector("rect").style.display = "block";
                return;
            }

            if (repeatState === 2) {
                isRepeatAll = false;
                audioPlayer.loop = true;
                repeatBtn.title = "Desactivar la repetición indefinida";
                repeatBtn.children[0].querySelector("rect").style.display = "none";
                repeatBtn.children[0].style.display = "none";
                repeatBtn.children[1].style.display = "block";
                return;
            }
        });

        const pauseAudio = () => {
            audioPlayer.pause();
            playIcon.style.display = "block";
            pauseIcon.style.display = "none";
            playPauseBtn.title = "Reproducir";
        };

        const playAudio = () => {
            audioPlayer.play().catch((error) => { });
            playIcon.style.display = "none";
            pauseIcon.style.display = "block";
            playPauseBtn.title = "Pausar";
        };

        const displaySongs = (songs) => {
            tbody.textContent = "";
            const fragment = d.createDocumentFragment();
            for (let idx = 0; idx < numFiles; idx++) {
                const tr = d.createElement("tr");
                tr.dataset.id = songs[idx].id;
                const { artist, title } = parseName(songs[idx].name);
                tr.innerHTML = `<td><span>${idx + 1}</span></td>
                <td><h3>${title}</h3><h4>${artist}</h4></td>
                <td><span>${formatTime(songs[idx].duration)}</span></td>`;
                fragment.appendChild(tr);
            }
            tbody.appendChild(fragment);

            tbody.children[songIndex].classList.add("playing");
            previousRowActive = tbody.children[songIndex];

            tbodyEventListenerClick();
        };

        const tbodyEventListenerClick = () => {
            tbody.addEventListener("click", (e) => {
                const tr = e.target.parentNode.parentNode;
                if (tr.tagName !== "TR") return;

                if (previousRowActive) previousRowActive.classList.remove("playing");
                tr.classList.add("playing");
                previousRowActive = tr;

                // Seteamos songIndex, solo cuando la reproducción es secuencial
                if (!isShuffle) songIndex = tr.rowIndex;
                // const song = songListCopy.find(song => song.id === +tr.dataset.id);
                const song = songMap.get(+tr.dataset.id);

                audioPlayer.src = isLocalFiles ? song.url : PATH + song.name;
                audioPlayer.dataset.songId = song.id;
                audioPlayer.load();
                playAudio();

                const infoSong = parseName(song.name);
                songInfo.textContent = infoSong.artist + " - " + infoSong.title;

                if (songInfo.scrollWidth > parentElementOffsetWidth) {
                    songInfo.style.animation = "slideIn 16s linear infinite";
                } else {
                    songInfo.style.animation = "none";
                }

            });
        };

        const loadSong = (songIndex) => {
            audioPlayer.src = isLocalFiles
                ? songListCopy[songIndex].url
                : PATH + songListCopy[songIndex].name;
            audioPlayer.dataset.songId = songListCopy[songIndex].id;
            audioPlayer.preload = "auto";
            audioPlayer.load();
            const song = parseName(songListCopy[songIndex].name);
            songInfo.textContent = song.artist + " - " + song.title;

            if (songInfo.scrollWidth > parentElementOffsetWidth) {
                songInfo.style.animation = "slideIn 16s linear infinite";
            } else {
                songInfo.style.animation = "none";
            }
        };

        const scrollToRow = () => {
            if (previousRowActive) previousRowActive.classList.remove("playing");
            previousRowActive = tbody.querySelector(
                `tr[data-id="${songListCopy[songIndex].id}"]`
            );
            previousRowActive.classList.add("playing");

            previousRowActive.scrollIntoView({ behavior: "smooth", block: "center" });
        };

        // https://introcs.cs.princeton.edu/java/14array/Deck.java.html
        const shuffle = (arr) => {
            const len = arr.length;
            // console.log(`Longitud de "len" en la función shuffle: ${len}`);
            // console.log(`Longitud de "numFiles" en la función shuffle: ${numFiles}`);
            for (let i = 0; i < len; i++) {
                const r = i + parseInt(Math.random() * (len - i));
                [arr[i], arr[r]] = [arr[r], arr[i]];
            }
            return arr;
        };

        const sequentialPlayback = (list) => {
            // Buscamos el índice
            songIndex = list.findIndex(
                (song) => song.id == audioPlayer.dataset["songId"]
            );
            // Devolvemos el orden del array original
            songListCopy = [...list];
        };

        const shufflePlayback = (list) => {
            // Encuentra el elemento y lo extrae del arreglo
            const currentlyPlayingSong = list.splice(
                list.findIndex((song) => song.id == audioPlayer.dataset["songId"]),
                1
            )[0];
            // Barajamos el arreglo sin la cancion actualmente en reproduccion
            // Nota en la función shuffle:
            // Al eliminar del array la canción actualmente en reproducción, nuestro array ahora tiene un elemento menos
            // Al llamar a la función shuffle, la función debería calcular nuevamente la longitud del array, por lo que
            // No podemos utilizar la variable numFiles que almacena la longitud del array al inicio del todo
            list = shuffle(list);
            // Enviamos al principio la canción que esta actualmente en reproducción despues de la mezcla
            list.unshift(currentlyPlayingSong);
        };

        const removeExt = (name) => {
            return name.slice(0, -4);
        };

        // https://www.w3schools.com/jsref/jsref_obj_string.asp
        const parseName = (name) => {
            return {
                artist: name.slice(0, name.indexOf(" - ")),
                title: name.slice(name.indexOf(" - ") + 3, -4),
            };

            // return [name.slice(0, name.indexOf(' - ')), name.slice(name.indexOf(' - ') + 3, -4)];
        };

        // Format time in hh:mm:ss or mm:ss
        const formatTime = (seconds, format = 0) => {
            seconds = Math.round(seconds); // 287.370158
            const hours = (seconds / 3600) | 0; // Hours calculation
            const minutes = ((seconds % 3600) / 60) | 0; // Minutes calculation
            const remainingSeconds = seconds % 60; // Whole seconds

            if (format === 0) {
                return hours > 0
                    ? // Show hours:minutes:seconds format
                    `${hours}:${minutes < 10 ? "0" + minutes : minutes}:${remainingSeconds < 10 ? "0" + remainingSeconds : remainingSeconds
                    }`
                    : // Show minutes:seconds format
                    `${/*minutes < 10 ? "0" + minutes : */ minutes}:${remainingSeconds < 10 ? "0" + remainingSeconds : remainingSeconds
                    }`;
            }

            return hours > 0
                ? // Show hours minutes seconds format => 10 h 8 min 47 s
                `${hours} h ${minutes} min ${remainingSeconds} s`
                : // Show minutes seconds format => 8 min 47 s
                `${minutes} min ${remainingSeconds} s`;
        };

        // Send request
        function sendHttpRequest(method, url, data, callback) {
            const xhr = getXhr();
            xhr.onreadystatechange = processRequest;
            function getXhr() {
                if (window.XMLHttpRequest) {
                    return new XMLHttpRequest();
                } else {
                    return new ActiveXObject("Microsoft.XMLHTTP");
                }
            }
            function processRequest() {
                if (xhr.readyState == XMLHttpRequest.DONE) {
                    if (xhr.status == 200 && xhr.response != null) {
                        if (callback) callback(xhr.response);
                    } else {
                        console.log(
                            "There was a problem retrieving the data: " + xhr.statusText
                        );
                    }
                }
            }
            xhr.open(method, url + (/\?/.test(url) ? "&" : "?") + new Date().getTime());
            xhr.onloadstart = function (e) {
                /*openLoader();*/
            };
            xhr.onloadend = function (e) {
                /*closeLoader();*/
            };
            if (data && !(data instanceof FormData))
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.send(data);
            xhr.onerror = function (e) {
                console.log("Error: " + e + " Could not load url.");
            };
        }


    </script>

</body>

</html>